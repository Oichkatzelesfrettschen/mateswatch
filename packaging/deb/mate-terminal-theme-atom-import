#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
usage: mate-terminal-theme-atom-import [--profile-id ID] [--set-default]

Imports the packaged Atom profile into *your* MATE Terminal dconf and ensures
the profile id is present in `org.mate.terminal.global profile-list`.

Notes:
  - Requires a running desktop session (D-Bus) for dconf/gsettings writes.
  - Does not remove or overwrite other profiles; it only adds the new profile id.

EOF
}

profile_id="Atom"
set_default="false"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --profile-id)
      profile_id="${2:-}"
      shift 2
      ;;
    --set-default)
      set_default="true"
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown argument: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if [[ -z "${profile_id}" ]]; then
  echo "error: --profile-id cannot be empty" >&2
  exit 2
fi

scheme_file="/usr/share/mate-terminal/profiles/Atom.dconf"
if [[ ! -f "${scheme_file}" ]]; then
  echo "error: missing ${scheme_file} (is the package installed?)" >&2
  exit 1
fi

if ! command -v dconf >/dev/null 2>&1; then
  echo "error: dconf not found (install dconf-cli / dconf)" >&2
  exit 1
fi

if ! command -v gsettings >/dev/null 2>&1; then
  echo "error: gsettings not found (install libglib2.0-bin / glib2)" >&2
  exit 1
fi

dconf load "/org/mate/terminal/profiles/${profile_id}/" < "${scheme_file}"

current="$(gsettings get org.mate.terminal.global profile-list 2>/dev/null || true)"
if [[ -z "${current}" ]]; then
  current="[]"
fi

if [[ "${current}" != *"'${profile_id}'"* ]]; then
  base="${current%]}"
  if [[ "${base}" == "[" ]]; then
    updated="['${profile_id}']"
  else
    updated="${base}, '${profile_id}']"
  fi
  gsettings set org.mate.terminal.global profile-list "${updated}"
fi

if [[ "${set_default}" == "true" ]]; then
  gsettings set org.mate.terminal.global default-profile "'${profile_id}'"
fi

echo "Imported Atom profile as id '${profile_id}'."
echo "Launch with: mate-terminal --profile=${profile_id}"

